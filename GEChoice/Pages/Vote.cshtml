@page "/vote"
@{
    ViewData["Title"] = "GECã©ã£ã¡ã§SHOW";
}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>@ViewData["Title"]</title>

    <!-- å¤–éƒ¨CSSï¼ˆwwwroot/css/vote.cssï¼‰ -->
    <link rel="stylesheet" href="~/css/vote.css" asp-append-version="true" />

    <script src="~/lib/signalr/signalr.min.js"></script>
</head>
<body>
    <header>
        <div class="title">GECã©ã£ã¡ã§SHOW</div>
        <div class="right">
            <span id="teamTag" class="tag hide"></span>
            <button id="editTeam" class="linkbtn">ãƒãƒ¼ãƒ åã‚’è¨­å®š</button>
        </div>
    </header>

    <main>
        <div class="card"><h2 id="q-title">èª­ã¿è¾¼ã¿ä¸­â€¦</h2></div>

        <div id="voting-area">
            <div class="card">
                <div class="multiplier-section">
                    <div class="multiplier-title">ç‚¹æ•°ã‚’é¸æŠï¼ˆå…¨3å•ã§å„ç‚¹æ•°ã¯1å›ãšã¤ä½¿ç”¨å¯èƒ½ï¼‰</div>
                    <div class="multipliers">
                        <button class="multiplier-btn" data-value="1"><div class="badge">1ç‚¹</div><div>1ç‚¹</div></button>
                        <button class="multiplier-btn" data-value="2"><div class="badge">2ç‚¹</div><div>2ç‚¹</div></button>
                        <button class="multiplier-btn" data-value="4"><div class="badge">4ç‚¹</div><div>4ç‚¹</div></button>
                    </div>
                </div>
            </div>
            <div class="card"><div class="choices" id="choices"></div></div>
        </div>

        <div id="voting-closed" class="card voting-closed hide">
            <div class="voting-closed-icon">â¸ï¸</div>
            <div>å›ç­”å—ä»˜åœæ­¢ä¸­</div>
            <div style="font-size:14px;margin-top:8px;">ãƒ›ã‚¹ãƒˆãŒå›ç­”é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§ãŠå¾…ã¡ãã ã•ã„</div>
        </div>

        <div id="msg">æº–å‚™ä¸­...</div>
        <div class="status"><span id="dot" class="dot"></span><span id="stxt">æ¥ç¶šæº–å‚™ä¸­â€¦</span></div>
    </main>

    <!-- ãƒãƒ¼ãƒ åå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="backdrop" class="modal-backdrop">
        <div class="modal">
            <h3>ãƒãƒ¼ãƒ åã‚’å…¥åŠ›</h3>
            <p>ç™ºè¡¨ã‚„é›†è¨ˆã§ä½¿ã†è¡¨ç¤ºåã§ã™ã€‚ã‚ã¨ã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ã€‚</p>
            <input id="teamInput" class="input" type="text" placeholder="ä¾‹ï¼‰ãƒãƒ¼ãƒ A" maxlength="40" />
            <div class="row">
                <button id="cancelTeam" class="btn">ã‚ã¨ã§</button>
                <button id="saveTeam" class="btn btn-acc">æ±ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        /* ===== å‚ç…§ ===== */
        const qTitle=document.getElementById('q-title');
        const wrap=document.getElementById('choices');
        const msg=document.getElementById('msg');
        const dot=document.getElementById('dot');
        const stxt=document.getElementById('stxt');
        const votingArea=document.getElementById('voting-area');
        const votingClosed=document.getElementById('voting-closed');
        const setConn=(ok,t)=>{dot.className='dot '+(ok?'ok':'ng');stxt.textContent=t||(ok?'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³':'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');};

        /* ===== çŠ¶æ…‹ ===== */
        let selectedMultiplier=1;
        let usedMultipliers=[];
        let isVotingOpen=false;
        let hasVotedThisRound=false;
        let currentSelectedOption=null;
        let savedVotes={};
        let currentQuestionIndex=0;

        /* ===== SignalR æ¥ç¶š & å®‰å…¨Invoker ===== */
        const conn=new signalR.HubConnectionBuilder()
          .withUrl('/hub/vote',{transport:signalR.HttpTransportType.WebSockets})
          .withAutomaticReconnect()
          .build();

        let isConnReady=false;
        const invokeQueue=[];
        function safeInvoke(method, ...args){
          if(isConnReady){
            return conn.invoke(method, ...args).catch(()=>{});
          }else{
            invokeQueue.push([method,args]);
            return Promise.resolve();
          }
        }
        function flushInvokeQueue(){
          while(invokeQueue.length){
            const [m,a]=invokeQueue.shift();
            conn.invoke(m, ...a).catch(()=>{});
          }
        }

        /* ===== ãƒãƒ¼ãƒ å ===== */
        const KEY='gec_team_name';
        const teamTag=document.getElementById('teamTag');
        const editTeam=document.getElementById('editTeam');
        const backdrop=document.getElementById('backdrop');
        const teamInput=document.getElementById('teamInput');
        const cancelTeam=document.getElementById('cancelTeam');
        const saveTeam=document.getElementById('saveTeam');

        function getTeam(){ return (localStorage.getItem(KEY)||'').trim(); }
        function setTeam(v){
          const name=(v||'').trim();
          if(name){ localStorage.setItem(KEY,name); teamTag.textContent='ğŸ‘¥ '+name; teamTag.classList.remove('hide'); }
          else{ localStorage.removeItem(KEY); teamTag.textContent=''; teamTag.classList.add('hide'); }
          safeInvoke('UpdateTeamName', name);
          updateVoteButtons();
        }
        function updateVoteButtons(){
          const teamNow=getTeam();
          const canVote=teamNow && isVotingOpen && selectedMultiplier>0 && !hasVotedThisRound;
          for(const b of document.querySelectorAll('.choice')) b.disabled=!canVote;
        }
        function openModal(prefill){ teamInput.value=prefill||getTeam(); backdrop.style.display='flex'; setTimeout(()=>teamInput.focus(),0); }
        function closeModal(){ backdrop.style.display='none'; }
        editTeam.onclick=()=>openModal();
        cancelTeam.onclick=()=>closeModal();
        saveTeam.onclick=()=>{
          const v=teamInput.value;
          if(!v || !v.trim()){ teamInput.focus(); return; }
          setTeam(v); closeModal(); msg.textContent='ãƒãƒ¼ãƒ åã‚’è¨­å®šã—ã¾ã—ãŸ';
        };

        /* ==== æ—¢å›ç­”ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’UIã«åæ˜ ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼‰ ==== */
        function applySavedVoteUI(){
          const saved = savedVotes[currentQuestionIndex];
          if(!isVotingOpen || !saved) return;

          hasVotedThisRound = true;
          currentSelectedOption = saved.option || null;
          selectedMultiplier = saved.multiplier || 0;

          // é¸æŠè‚¢ãƒœã‚¿ãƒ³å›ºå®šï¼†ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          document.querySelectorAll('.choice').forEach(b=>{
            b.disabled = true;
            const txt = b.textContent||'';
            if(currentSelectedOption && txt.startsWith(currentSelectedOption+' ')){
              b.classList.add('selected-answer');
            }
          });

          // å€ç‡ãƒœã‚¿ãƒ³ï¼šä½¿ã£ãŸå€ç‡ã ã‘é¸æŠå›ºå®šã€ä»–ã¯è§¦ã‚Œãªã„
          document.querySelectorAll('.multiplier-btn').forEach(btn=>{
            const v = parseInt(btn.dataset.value);
            btn.classList.remove('selected');
            if(v === selectedMultiplier){
              btn.disabled = true;
              btn.classList.add('used','selected');
              btn.style.pointerEvents = 'none';
              btn.style.opacity = '0.7';
            }else{
              btn.style.pointerEvents = 'none';
              btn.style.opacity = '0.7';
              if(usedMultipliers.includes(v)){
                btn.disabled = true;
                btn.classList.add('used');
              }
            }
          });

          msg.textContent = `ã“ã®å•é¡Œã¯ ${currentSelectedOption} (${selectedMultiplier||'?'}ç‚¹) ã§å›ç­”æ¸ˆã¿ã§ã™`;
        }

        /* ===== SignalR: StateUpdated ===== */
        conn.on('StateUpdated', s=>{
          const q=s.question||{}; const opts=q.options||[];
          isVotingOpen=s.isVotingOpen||false;
          const newIndex=s.currentIndex||0;

          // å•é¡Œåˆ‡æ›¿æ™‚ã«è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
          if(newIndex!==currentQuestionIndex){
            currentQuestionIndex=newIndex;
            hasVotedThisRound=false; currentSelectedOption=null;
            document.querySelectorAll('.choice').forEach(b=>b.classList.remove('selected-answer'));
          }

          // ã‚µãƒ¼ãƒã®è‡ªãƒãƒ¼ãƒ å›ç­”ãŒç„¡ã‘ã‚Œã°ã€ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’è§£æ”¾ï¼ˆ=ãƒ›ã‚¹ãƒˆãŒå‰Šé™¤ã—ãŸã‚±ãƒ¼ã‚¹ï¼‰
          const myTeam=(getTeam()||'').trim();
          const serverHasMyVote = !!(s.clientVotes && myTeam && s.clientVotes[myTeam]);
          const localSaved = savedVotes[currentQuestionIndex];
          if(!serverHasMyVote && localSaved){
            const freed = Number(localSaved.multiplier||0);
            delete savedVotes[currentQuestionIndex];
            localStorage.setItem('gec_saved_votes', JSON.stringify(savedVotes));
            if(freed && usedMultipliers.includes(freed)){
              usedMultipliers = usedMultipliers.filter(x=>x!==freed);
              localStorage.setItem('gec_used_multipliers', JSON.stringify(usedMultipliers));
            }
            hasVotedThisRound=false;
            currentSelectedOption=null;
            selectedMultiplier=0;
          }

          qTitle.textContent=q.title||'';

          if(isVotingOpen){
            votingArea.classList.remove('hide'); votingClosed.classList.add('hide');
            msg.textContent = hasVotedThisRound ? `ã“ã®å•é¡Œã¯ ${currentSelectedOption} (${savedVotes[currentQuestionIndex]?.multiplier||'?'}ç‚¹) ã§å›ç­”æ¸ˆã¿ã§ã™` : 'ç‚¹æ•°ã‚’é¸æŠã—ã¦ã‹ã‚‰å›ç­”ã—ã¦ãã ã•ã„';
          }else{
            votingArea.classList.add('hide'); votingClosed.classList.remove('hide'); msg.textContent='å›ç­”å—ä»˜åœæ­¢ä¸­';
          }

          // é¸æŠè‚¢å†æç”»
          wrap.innerHTML='';
          const teamNow=getTeam();
          for(const o of opts){
            const label=o.label??o.Label??'-';
            const b=document.createElement('button');
            b.className='choice'; b.textContent=`${label} ã‚’é¸ã¶`;
            b.disabled=!teamNow || !isVotingOpen || selectedMultiplier===0 || hasVotedThisRound;
            if(currentSelectedOption===label) b.classList.add('selected-answer');
            b.onclick=()=>{
              if(!selectedMultiplier){ msg.textContent='å…ˆã«ç‚¹æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„'; return; }
              if(hasVotedThisRound){ msg.textContent='ã“ã®å•é¡Œã¯æ—¢ã«å›ç­”æ¸ˆã¿ã§ã™'; return; }
              showConfirmModal(label, teamNow);
            };
            wrap.appendChild(b);
          }
          setConn(true);
          updateVoteButtons();

          // ãƒªãƒ­ãƒ¼ãƒ‰ç›´å¾Œã®å¾©å…ƒ
          applySavedVoteUI();
        });

        /* é–‹å§‹/çµ‚äº† */
        conn.on('VotingStatusChanged', isOpen=>{
          isVotingOpen=isOpen;
          if(isOpen){
            hasVotedThisRound=false; currentSelectedOption=null;
            document.querySelectorAll('.multiplier-btn').forEach(btn=>{
              const v=parseInt(btn.dataset.value);
              btn.classList.remove('selected');
              if(usedMultipliers.includes(v)){ btn.disabled=true; btn.classList.add('used'); btn.style.pointerEvents=''; btn.style.opacity=''; }
              else{ btn.disabled=false; btn.classList.remove('used'); btn.style.pointerEvents=''; btn.style.opacity=''; }
            });
            selectedMultiplier=0;
            votingArea.classList.remove('hide'); votingClosed.classList.add('hide');
            msg.textContent='ç‚¹æ•°ã‚’é¸æŠã—ã¦ã‹ã‚‰å›ç­”ã—ã¦ãã ã•ã„';
            applySavedVoteUI();
          }else{
            votingArea.classList.add('hide'); votingClosed.classList.remove('hide'); msg.textContent='å›ç­”å—ä»˜åœæ­¢ä¸­';
          }
          updateVoteButtons();
        });

        /* å›ç­”ç¢ºå®šï¼šè‡ªå‹•ã‚·ãƒ•ãƒˆã•ã›ãªã„ */
        conn.on('MultiplierUsed', multiplier=>{
          if(!usedMultipliers.includes(multiplier)) usedMultipliers.push(multiplier);
          hasVotedThisRound=true;
          selectedMultiplier = multiplier;
          document.querySelectorAll('.multiplier-btn').forEach(btn=>{
            const v=parseInt(btn.dataset.value);
            if(v===multiplier){ btn.disabled=true; btn.classList.add('used','selected'); }
            else{
              btn.style.pointerEvents='none'; btn.style.opacity='0.7';
              if(usedMultipliers.includes(v)){ btn.disabled=true; btn.classList.add('used'); }
            }
          });
          if(currentSelectedOption){
            if(!savedVotes[currentQuestionIndex]) savedVotes[currentQuestionIndex]={};
            savedVotes[currentQuestionIndex]={ option: currentSelectedOption, multiplier };
            localStorage.setItem('gec_saved_votes', JSON.stringify(savedVotes));
          }
          localStorage.setItem('gec_used_multipliers', JSON.stringify(usedMultipliers));
          updateVoteButtons();
        });

        /* å›ç­”ä¸€è¦§ï¼ˆãƒ›ã‚¹ãƒˆã¨åŒã˜ï¼‰ */
        conn.on('ShowPerQuestionResults',(index,rows)=>{
          const myTeam=(getTeam()||'').trim();
          const groups={A:[],B:[]};
          (rows||[]).forEach(r=>{
            const opt=String(r.selectedOption||r.SelectedOption||'-').toUpperCase();
            const team=String(r.teamName||r.TeamName||'').trim();
            const mul=Number(r.multiplier||r.Multiplier||1);
            const rt=Number(r.responseTime||r.ResponseTime||0);
            if(!team) return;
            if(opt==='A'||opt==='B') groups[opt].push({team,mul,rt});
          });
          const countA=groups.A.length, countB=groups.B.length;

          const modal=document.createElement('div');
          modal.className='confirm-modal'; modal.style.display='flex'; modal.style.zIndex='2000';

          let html='';
          ['A','B'].forEach(opt=>{
            const list=groups[opt];
            html+=`
              <div style="margin-bottom:20px;padding:16px;background:#f9fafb;border-radius:8px;">
                <div style="font-size:18px;font-weight:700;color:#111;margin-bottom:12px;">
                  é¸æŠè‚¢ ${opt} <span style="font-weight:400;color:#666;">(${list.length}ãƒãƒ¼ãƒ )</span>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:8px;">
                  ${list.map(x=>{
                    const mine=x.team===myTeam;
                    return `<div style="padding:8px 12px;background:${mine?'#fef3c7':'#fff'};border:1px solid ${mine?'#f59e0b':'#e5e7eb'};border-radius:6px;">
                              <span style="font-weight:600;">${x.team}</span>
                              <span style="color:#666;margin-left:8px;">Ã—${x.mul}</span>
                              ${mine?'<span style="color:#f59e0b;margin-left:8px;">(ã‚ãªãŸ)</span>':''}
                            </div>`;
                  }).join('') || `<div style="color:#666;font-style:italic;">å›ç­”ãªã—</div>`}
                </div>
              </div>`;
          });

          modal.innerHTML=`
            <div class="confirm-box">
              <div class="confirm-title">å›ç­”ä¸€è¦§ï¼ˆA: ${countA}ãƒãƒ¼ãƒ  / B: ${countB}ãƒãƒ¼ãƒ ï¼‰</div>
              <div style="margin:20px 0; max-height:60vh; overflow:auto;">${html}</div>
              <div class="confirm-buttons">
                <button class="confirm-btn confirm-ok" style="width:100%;font-size:18px;padding:18px;">é–‰ã˜ã‚‹</button>
              </div>
            </div>`;
          document.body.appendChild(modal);
          modal.querySelector('.confirm-ok').onclick=()=> document.body.removeChild(modal);
        });
        conn.on('ClosePerQuestionResults',()=>{ const m=document.querySelector('.confirm-modal'); if(m) m.remove(); });

        /* æœ€çµ‚çµæœ */
        conn.on('GameResults', results=>{
          const modal=document.createElement('div');
          modal.className='confirm-modal'; modal.style.display='flex'; modal.style.zIndex='2000';
          let html='<table style="width:100%;border-collapse:collapse;"><tr><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">é †ä½</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">ãƒãƒ¼ãƒ å</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">åˆè¨ˆç‚¹æ•°</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">åˆè¨ˆæ™‚é–“(ç§’)</th></tr>';
          (results||[]).forEach((r,i)=>{
            const rank=i+1, badge=rank===1?' ğŸ†':(rank===2?' ğŸ¥ˆ':(rank===3?' ğŸ¥‰':''));
            const teamName=(r.teamName||r.TeamName||'').trim();
            const t=(r.totalTime||r.TotalTime||0).toFixed(1);
            html+=`<tr><td style="padding:8px;border-bottom:1px solid #e5e7eb;">${rank}${badge}</td><td style="padding:8px;border-bottom:1px solid #e5e7eb;">${teamName||'ï¼ˆæœªè¨­å®šï¼‰'}</td><td style="padding:8px;border-bottom:1px solid #e5e7eb;">${r.totalPoints||r.TotalPoints||0}ç‚¹</td><td style="padding:8px;border-bottom:1px solid #e5e7eb;">${t}</td></tr>`;
          });
          html+='</table>';
          modal.innerHTML=`
            <div class="confirm-box" style="max-width:600px;">
              <div class="confirm-title">æœ€çµ‚çµæœ</div>
              <div style="margin:20px 0;overflow-x:auto;">${html}</div>
              <div class="confirm-buttons"><button class="confirm-btn confirm-ok" style="width:100%;font-size:18px;padding:18px;">é–‰ã˜ã‚‹</button></div>
            </div>`;
          document.body.appendChild(modal);
          modal.querySelector('.confirm-ok').onclick=()=> document.body.removeChild(modal);
        });

        /* â˜… å›ç­”å‰Šé™¤ï¼šæœªä½¿ç”¨ã®å€ç‡ã¯å†é¸æŠå¯ã«æˆ»ã™ï¼†è‡ªå‹•é¸æŠãªã—ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ï¼‰ */
        conn.on('VoteDeleted',(clientId,deletedMultiplier)=>{
          const myId=conn.connectionId;
          if(!myId || clientId!==myId) return;

          if(deletedMultiplier && usedMultipliers.includes(deletedMultiplier)){
            usedMultipliers = usedMultipliers.filter(x=>x!==deletedMultiplier);
            localStorage.setItem('gec_used_multipliers', JSON.stringify(usedMultipliers));
          }

          // ã“ã®è¨­å•ã®ãƒ­ãƒ¼ã‚«ãƒ«å›ç­”ã‚‚è§£é™¤
          if(savedVotes[currentQuestionIndex]){
            delete savedVotes[currentQuestionIndex];
            localStorage.setItem('gec_saved_votes', JSON.stringify(savedVotes));
          }

          hasVotedThisRound=false;
          currentSelectedOption=null;
          selectedMultiplier=0;
          document.querySelectorAll('.choice').forEach(b=>b.classList.remove('selected-answer'));

          document.querySelectorAll('.multiplier-btn').forEach(btn=>{
            const v=parseInt(btn.dataset.value);
            btn.classList.remove('selected');
            btn.style.pointerEvents='';
            btn.style.opacity='';
            if(usedMultipliers.includes(v)){ btn.disabled=true; btn.classList.add('used'); }
            else{ btn.disabled=false; btn.classList.remove('used'); }
          });

          msg.textContent='å›ç­”ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚å€ç‡ã‚’é¸ã³ç›´ã—ã¦å›ç­”ã§ãã¾ã™';
          updateVoteButtons();
        });

        /* æ¥ç¶š */
        conn.start()
          .then(()=>{
            isConnReady=true;
            setConn(true,'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³');
            flushInvokeQueue();
            const n=getTeam();
            if(n) safeInvoke('UpdateTeamName', n);
            return safeInvoke('GetState');
          })
          .catch(()=> setConn(false,'æ¥ç¶šã§ãã¾ã›ã‚“'));

        conn.onreconnecting(()=>{ isConnReady=false; setConn(false,'å†æ¥ç¶šä¸­â€¦'); });
        conn.onreconnected(()=>{
          isConnReady=true;
          setConn(true,'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³');
          flushInvokeQueue();
          const n=getTeam();
          if(n) safeInvoke('UpdateTeamName', n);
          safeInvoke('GetState');
        });
        conn.onclose(()=> setConn(false,'åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ'));
        addEventListener('offline', ()=> setConn(false,'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'));
        addEventListener('online',  ()=> setConn(true,'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'));

        /* èµ·å‹•æ™‚ï¼šãƒ­ãƒ¼ã‚«ãƒ«å¾©å…ƒï¼ˆä½¿ç”¨æ¸ˆã¿å€ç‡ã®è¦‹ãŸç›®ã ã‘å…ˆã«åæ˜ ï¼‰ */
        window.addEventListener('load',()=>{
          const name=getTeam(); setTeam(name); if(!name){ openModal(''); }
          const savedData=localStorage.getItem('gec_saved_votes');
          const savedM=localStorage.getItem('gec_used_multipliers');
          if(savedData){ try{ savedVotes=JSON.parse(savedData);}catch{ localStorage.removeItem('gec_saved_votes'); } }
          if(savedM){ try{
            usedMultipliers=JSON.parse(savedM);
            usedMultipliers.forEach(m=>{ const btn=document.querySelector(`.multiplier-btn[data-value="${m}"]`); if(btn){ btn.disabled=true; btn.classList.add('used'); }});
          }catch{ localStorage.removeItem('gec_used_multipliers'); } }
          document.querySelectorAll('.multiplier-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
              if(btn.disabled||btn.classList.contains('used')) return;
              if(hasVotedThisRound){ msg.textContent='å›ç­”å¾Œã¯å€ç‡ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“'; return; }
              document.querySelectorAll('.multiplier-btn').forEach(b=>b.classList.remove('selected'));
              btn.classList.add('selected'); selectedMultiplier=parseInt(btn.dataset.value);
              updateVoteButtons(); msg.textContent=`${selectedMultiplier}ç‚¹ã‚’é¸æŠã—ã¾ã—ãŸ`;
            });
          });
          document.querySelector('.multiplier-btn[data-value="1"]').classList.add('selected');
        });

        /* ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ›ã‚¹ãƒˆæ“ä½œåæ˜ ï¼‰ */
        conn.on('GameReset', ()=>{
          usedMultipliers=[]; selectedMultiplier=1; hasVotedThisRound=false; currentSelectedOption=null; savedVotes={}; currentQuestionIndex=0;
          localStorage.removeItem('gec_saved_votes'); localStorage.removeItem('gec_used_multipliers');
          document.querySelectorAll('.multiplier-btn').forEach(btn=>{ btn.disabled=false; btn.classList.remove('used','selected'); });
          document.querySelector('.multiplier-btn[data-value="1"]').classList.add('selected');
          document.querySelectorAll('.choice').forEach(b=>b.classList.remove('selected-answer'));
          msg.textContent='ã‚²ãƒ¼ãƒ ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ';
        });

        /* é€ä¿¡ç¢ºèªï¼ˆé€ä¿¡æ™‚ã®å€ç‡ã‚’å›ºå®šè¡¨ç¤ºï¼‰ */
        function showConfirmModal(label,teamName){
          const modal=document.createElement('div');
          modal.className='confirm-modal'; modal.style.display='flex';
          modal.innerHTML=`
            <div class="confirm-box">
              <div class="confirm-title">ğŸ“ å›ç­”ç¢ºèª</div>
              <div class="confirm-message">ã“ã®é¸æŠã§å›ç­”ã—ã¾ã™ã€‚<br>ä¸€åº¦å›ç­”ã™ã‚‹ã¨å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚</div>
              <div class="confirm-choice">${label}</div>
              <div class="confirm-choice-detail">
                <div class="confirm-choice-item"><div class="confirm-choice-label">ãƒãƒ¼ãƒ å</div><div class="confirm-choice-value">${teamName||'æœªè¨­å®š'}</div></div>
                <div class="confirm-choice-item"><div class="confirm-choice-label">ä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆ</div><div class="confirm-choice-value">${selectedMultiplier||'-'}ç‚¹</div></div>
              </div>
              <div class="confirm-buttons">
                <button class="confirm-btn confirm-cancel">æˆ»ã‚‹</button>
                <button class="confirm-btn confirm-ok">ç¢ºå®šã™ã‚‹ âœ“</button>
              </div>
            </div>`;
          document.body.appendChild(modal);

          modal.querySelector('.confirm-cancel').onclick=()=> document.body.removeChild(modal);
          modal.querySelector('.confirm-ok').onclick=()=>{
            const chosenMultiplier = selectedMultiplier;
            if(!chosenMultiplier){ msg.textContent='å…ˆã«ç‚¹æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„'; return; }
            currentSelectedOption=label;
            // æ¥ç¶šæº–å‚™ãŒã§ãã¦ã„ãªã„å ´åˆã§ã‚‚å®‰å…¨ã«ã‚­ãƒ¥ãƒ¼ã—ã¦é€ä¿¡
            safeInvoke('SubmitWithMultiplier', label, chosenMultiplier, teamName);
            msg.textContent=`${teamName?('['+teamName+'] '):''}${label} ã‚’ ${chosenMultiplier}ç‚¹ã§é¸æŠã—ã¾ã—ãŸ`;
            try{ navigator.vibrate && navigator.vibrate(15);}catch{}
            document.body.removeChild(modal);
          };
        }
    </script>
</body>
</html>
