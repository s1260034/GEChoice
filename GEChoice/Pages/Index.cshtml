@page "/"
@inject IConfiguration Config
@{
    ViewData["Title"] = "GECどっちでSHOW - ホスト";
    var joinUrl = Config["JoinUrl"] ?? "http:192.168.10.3:8080/vote";
}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>

    <!-- 外部CSS（wwwroot/css/index.css） -->
    <link rel="stylesheet" href="~/css/index.css" asp-append-version="true" />

    <script src="~/lib/signalr/signalr.min.js"></script>
    <script src="~/lib/qrious/qrious.min.js"></script>
</head>
<body>
    <header>
        <div class="brand">GECどっちでSHOW - ホスト画面</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="show-qr-modal" class="btn">QR</button>
            <button id="start-voting" class="btn btn-start">回答開始</button>
            <button id="stop-voting" class="btn btn-stop" style="display:none;">回答終了</button>
            <button id="show-result" class="btn btn-result" style="display:none;">回答一覧</button>
            <button id="prev" class="btn">前の問題</button>
            <button id="next" class="btn">次の問題</button>
            <button id="reset" class="btn">リセット</button>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div class="muted">問題 <span id="q-num">1</span></div>
                    <h2 id="q-title" style="margin:6px 0 12px;">読み込み中…</h2>
                </div>
                <div style="text-align:right;">
                    <div class="muted">ステータス</div>
                    <div id="voting-status">
                        <span class="status-indicator status-closed"></span>
                        <span>回答受付停止中</span>
                    </div>
                    <div id="timer" class="timer" style="display:none;">0秒</div>
                </div>
            </div>
            <div id="opts" class="grid"></div>
        </div>

        <div class="card">
            <div class="muted">参加者一覧（チーム名）</div>
            <div id="participants"><p class="muted">まだ参加者がいません</p></div>
        </div>

        <div class="card">
            <div class="muted">参加者の回答状況（この問題）</div>
            <div id="client-status"><p class="muted">まだ回答がありません</p></div>
        </div>

        <div class="card">
            <div class="muted">途中経過（合計）</div>
            <div id="interim-totals"><p class="muted">回答終了後に更新されます</p></div>
        </div>

        <div class="card">
            <div class="muted">問題別結果</div>
            <div id="question-results"><p class="muted">回答終了後に表示されます</p></div>
        </div>
    </div>

    <!-- 最終結果モーダル -->
    <div id="final-results-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:32px;border-radius:16px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;">
            <h2>最終結果（同点は合計時間の短い方が上位）</h2>
            <div id="final-results-content"></div>
            <button onclick="document.getElementById('final-results-modal').style.display='none'" class="btn" style="margin-top:16px;">閉じる</button>
        </div>
    </div>

    <!-- QRコードモーダル -->
    <div id="qr-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:32px;border-radius:16px;max-width:500px;width:90%;">
            <h2 style="margin-top:0;">参加用QRコード</h2>
            <div style="text-align:center;margin:24px 0;"><canvas id="qr" width="250" height="250"></canvas></div>
            <div style="text-align:center;margin:16px 0;">
                <div style="color:#666;font-size:14px;margin-bottom:8px;">参加URL</div>
                <div style="background:#f3f4f6;padding:12px;border-radius:8px;word-break:break-all;">
                    <a id="join-link" href="@joinUrl" target="_blank" style="color:#22c55e;font-weight:600;text-decoration:none;">@joinUrl</a>
                </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:24px;">
                <button id="edit-url" class="btn" style="flex:1;">URLを変更</button>
                <button onclick="document.getElementById('qr-modal').style.display='none'" class="btn" style="flex:1;background:linear-gradient(90deg,#22c55e,#16a34a);color:#fff;border:none;">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 回答一覧モーダル（クライアントにも同内容を配信） -->
    <div id="answer-list-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:32px;border-radius:16px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;">
            <h2 id="answer-list-title" style="margin-top:0;margin-bottom:8px;">回答一覧</h2>
            <div id="answer-list-question" style="color:#666;margin-bottom:20px;font-size:18px;font-weight:600;"></div>
            <div id="answer-list-content" style="margin-bottom:24px;"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button id="close-answer-list" class="btn" style="background:#6b7280;color:#fff;border:none;">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        // Razorから渡される変数をグローバル変数として設定
        window.joinUrlFromServer = "@joinUrl";
    </script>
    <script src="~/js/index.js"></script>
</body>
</html>
