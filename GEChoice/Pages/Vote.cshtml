@page "/vote"
@{
    ViewData["Title"] = "GECã©ã£ã¡ã§SHOW";
}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>@ViewData["Title"]</title>
    <script src="~/lib/signalr/signalr.min.js"></script>
    <style>
        :root {
            --bd: #e5e7eb;
            --txt: #222;
            --muted: #666;
            --g1: #22c55e;
            --g2: #16a34a;
            --blue: #3b82f6;
            --yellow: #eab308;
            --red: #ef4444;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent
        }

        html, body { height: 100% }

        body {
            margin: 0;
            background: #fff;
            color: var(--txt);
            font-family: 'Inter',system-ui,sans-serif
        }

        header {
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            border-bottom: 1px solid var(--bd);
            background: #fff;
        }

        header .title {
            font-weight: 800;
            margin-left: 4px;
        }

        main {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px
        }

        .card {
            background: #fff;
            border: 1px solid var(--bd);
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,.06);
            padding: 16px
        }

        .multiplier-section {
            margin-bottom: 16px;
        }

        .multiplier-title {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .multipliers {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .multiplier-btn {
            appearance: none;
            border: 2px solid var(--bd);
            border-radius: 10px;
            padding: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            background: #fff;
            transition: all .15s ease;
            position: relative;
        }

        .multiplier-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }

        .multiplier-btn.selected {
            border-color: var(--g1);
            background: linear-gradient(135deg, var(--g1), var(--g2));
            color: #fff;
        }

        .multiplier-btn:disabled {
            opacity: .4;
            cursor: not-allowed;
            background: #f3f4f6;
        }

        .multiplier-btn.used {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #9ca3af;
        }

        .multiplier-btn .badge {
            display: inline-block;
            font-size: 20px;
            margin-bottom: 4px;
        }

        .choices {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(auto-fit,minmax(140px,1fr))
        }

        .choice {
            appearance: none;
            border: none;
            border-radius: 14px;
            padding: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(90deg,var(--g1),var(--g2));
            color: #fff;
            box-shadow: 0 6px 16px rgba(34,197,94,.3);
            transition: transform .08s ease
        }

        .choice:active {
            transform: scale(.96)
        }

        .choice:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        /* æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã‚’å¼·èª¿ã€ä»–ã¯è–„ã */
        .choice.selected {
            box-shadow: 0 10px 22px rgba(34,197,94,.38);
            filter: saturate(1.05);
            position: relative;
        }

        .choice.selected::after {
            content: "âœ“";
            position: absolute;
            right: 12px;
            top: 10px;
            font-weight: 800;
        }

        .choice.dim {
            opacity: .55;
        }

        #msg {
            color: #555;
            font-size: 13px;
            min-height: 20px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px;
            text-align: center;
        }

        .status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border: 1px solid var(--bd);
            border-radius: 10px;
            font-size: 13px;
            color: #666
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc
        }

        .ok { background: #22c55e }
        .ng { background: #ef4444 }
        
        .voting-closed {
            text-align: center;
            padding: 32px;
            color: var(--muted);
            font-size: 16px;
        }
        
        .voting-closed-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.35);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px
        }

        .modal {
            width: 100%;
            max-width: 420px;
            background: #fff;
            border: 1px solid var(--bd);
            border-radius: 14px;
            box-shadow: 0 20px 50px rgba(0,0,0,.18);
            padding: 18px
        }

        .modal h3 {
            margin: 0 0 8px
        }

        .modal p {
            margin: 0 0 14px;
            color: var(--muted);
            font-size: 14px
        }

        .input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--bd);
            border-radius: 10px;
            font-size: 16px
        }

        .row {
            display: flex;
            gap: 8px;
            margin-top: 12px
        }

        .btn {
            flex: 1;
            cursor: pointer;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--bd);
            background: #fff;
            font-weight: 700
        }

        .btn-acc {
            border-color: transparent;
            background: linear-gradient(90deg,var(--g1),var(--g2));
            color: #fff
        }

        .hide { display: none }

        .right {
            position: absolute;
            right: 12px;
            top: 10px;
            display: flex;
            gap: 8px;
            align-items: center
        }

        .tag {
            border: 1px solid var(--bd);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            color: #333;
            background: #f9fafb
        }

        .linkbtn {
            border: none;
            background: none;
            color: var(--g1);
            font-weight: 700;
            cursor: pointer
        }

        .linkbtn:active { opacity: .7 }

        .selected-answer {
            background: linear-gradient(90deg, #fbbf24, #f59e0b) !important;
            position: relative;
        }
        
        .selected-answer::after {
            content: 'âœ“ é¸æŠæ¸ˆã¿';
            position: absolute;
            top: -10px;
            right: 10px;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .confirm-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        
        .confirm-box {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,.25);
        }
        
        .confirm-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .confirm-message {
            color: var(--muted);
            margin-bottom: 20px;
            line-height: 1.5;
            text-align: center;
        }
        
        .confirm-choice {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 20px;
            border-radius: 14px;
            font-size: 32px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .confirm-choice::before {
            content: 'âœ¨';
            position: absolute;
            top: 8px;
            left: 16px;
            font-size: 20px;
        }
        
        .confirm-choice::after {
            content: 'âœ¨';
            position: absolute;
            top: 8px;
            right: 16px;
            font-size: 20px;
        }
        
        .confirm-choice-detail {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 10px;
        }
        
        .confirm-choice-item {
            text-align: center;
        }
        
        .confirm-choice-label {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 4px;
        }
        
        .confirm-choice-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--g1);
        }
        
        .confirm-buttons {
            display: flex;
            gap: 8px;
        }
        
        .confirm-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.1s ease;
        }
        
        .confirm-btn:hover {
            transform: translateY(-2px);
        }
        
        .confirm-cancel {
            background: #f3f4f6;
            color: #666;
        }
        
        .confirm-ok {
            background: linear-gradient(90deg,var(--g1),var(--g2));
            color: white;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
    </style>
</head>
<body>
    <header>
        <div class="title">GECã©ã£ã¡ã§SHOW</div>
        <div class="right">
            <span id="teamTag" class="tag hide"></span>
            <button id="editTeam" class="linkbtn">ãƒãƒ¼ãƒ åã‚’è¨­å®š</button>
        </div>
    </header>

    <main>
        <div class="card">
            <h2 id="q-title">èª­ã¿è¾¼ã¿ä¸­â€¦</h2>
        </div>
        
        <div id="voting-area">
            <div class="card">
                <div class="multiplier-section">
                    <div class="multiplier-title">ç‚¹æ•°ã‚’é¸æŠï¼ˆå…¨3å•ã§å„ç‚¹æ•°ã¯1å›ãšã¤ä½¿ç”¨å¯èƒ½ï¼‰</div>
                    <div class="multipliers">
                        <button class="multiplier-btn" data-value="1">
                            <div class="badge">1ç‚¹</div>
                            <div>1ç‚¹</div>
                        </button>
                        <button class="multiplier-btn" data-value="2">
                            <div class="badge">2ç‚¹</div>
                            <div>2ç‚¹</div>
                        </button>
                        <button class="multiplier-btn" data-value="4">
                            <div class="badge">4ç‚¹</div>
                            <div>4ç‚¹</div>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="choices" id="choices"></div>
            </div>
        </div>
        
        <div id="voting-closed" class="card voting-closed hide">
            <div class="voting-closed-icon">â¸ï¸</div>
            <div>å›ç­”å—ä»˜åœæ­¢ä¸­</div>
            <div style="font-size:14px;margin-top:8px;">ãƒ›ã‚¹ãƒˆãŒå›ç­”é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§ãŠå¾…ã¡ãã ã•ã„</div>
        </div>
        
        <div id="msg">æº–å‚™ä¸­...</div>
        <div class="status"><span id="dot" class="dot"></span><span id="stxt">æ¥ç¶šæº–å‚™ä¸­â€¦</span></div>
    </main>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒãƒ¼ãƒ åå…¥åŠ› -->
    <div id="backdrop" class="modal-backdrop">
        <div class="modal">
            <h3>ãƒãƒ¼ãƒ åã‚’å…¥åŠ›</h3>
            <p>ç™ºè¡¨ã‚„é›†è¨ˆã§ä½¿ã†è¡¨ç¤ºåã§ã™ã€‚ã‚ã¨ã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ã€‚</p>
            <input id="teamInput" class="input" type="text" placeholder="ä¾‹ï¼‰ãƒãƒ¼ãƒ A" maxlength="40" />
            <div class="row">
                <button id="cancelTeam" class="btn">ã‚ã¨ã§</button>
                <button id="saveTeam" class="btn btn-acc">æ±ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        /* ===== æ¥ç¶šUI ===== */
        const qTitle=document.getElementById('q-title');
        const wrap=document.getElementById('choices');
        const msg=document.getElementById('msg');
        const dot=document.getElementById('dot');
        const stxt=document.getElementById('stxt');
        const votingArea=document.getElementById('voting-area');
        const votingClosed=document.getElementById('voting-closed');
        const setConn=(ok,t)=>{dot.className='dot '+(ok?'ok':'ng');stxt.textContent=t||(ok?'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³':'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');};

        /* ===== å€ç‡ç®¡ç† ===== */
        let selectedMultiplier = 1;
        let usedMultipliers = [];
        let isVotingOpen = false;
        let hasVotedThisRound = false;
        let currentSelectedOption = null;
        let savedVotes = {}; // å„å•é¡Œã”ã¨ã®å›ç­”ã‚’ä¿æŒ
        let currentQuestionIndex = 0;

        /* ===== ãƒãƒ¼ãƒ åï¼šlocalStorage ç®¡ç† ===== */
        const KEY='gec_team_name';
        const teamTag=document.getElementById('teamTag');
        const editTeam=document.getElementById('editTeam');
        const backdrop=document.getElementById('backdrop');
        const teamInput=document.getElementById('teamInput');
        const cancelTeam=document.getElementById('cancelTeam');
        const saveTeam=document.getElementById('saveTeam');

        function getTeam(){ return (localStorage.getItem(KEY)||'').trim(); }
        function setTeam(v){
          const name=(v||'').trim();
          if(name){ localStorage.setItem(KEY,name); teamTag.textContent='ğŸ‘¥ ' + name; teamTag.classList.remove('hide'); }
          else{ localStorage.removeItem(KEY); teamTag.textContent=''; teamTag.classList.add('hide'); }
          updateVoteButtons();
        }
        
        function updateVoteButtons(){
          const teamNow = getTeam();
          const canVote = teamNow && isVotingOpen && selectedMultiplier > 0;
          for(const b of document.querySelectorAll('.choice')) {
            b.disabled = !canVote;
          }
        }
        
        function openModal(prefill){
          teamInput.value=prefill||getTeam();
          backdrop.style.display='flex';
          setTimeout(()=> teamInput.focus(), 0);
        }
        function closeModal(){ backdrop.style.display='none'; }

        editTeam.onclick=()=> openModal();
        cancelTeam.onclick=()=> closeModal();
        saveTeam.onclick=()=>{
          const v=teamInput.value;
          if(!v || !v.trim()){ teamInput.focus(); return; }
          setTeam(v); closeModal(); msg.textContent='ãƒãƒ¼ãƒ åã‚’è¨­å®šã—ã¾ã—ãŸ';
        };

        window.addEventListener('load', ()=>{
          const name=getTeam();
          setTeam(name);
          if(!name){ openModal(''); }
          
          // localStorageã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
          const savedData = localStorage.getItem('gec_saved_votes');
          const savedMultipliers = localStorage.getItem('gec_used_multipliers');
          
          if (savedData) {
            try {
              savedVotes = JSON.parse(savedData);
            } catch (e) {
              localStorage.removeItem('gec_saved_votes');
            }
          }
          
          if (savedMultipliers) {
            try {
              usedMultipliers = JSON.parse(savedMultipliers);
              // ä½¿ç”¨æ¸ˆã¿å€ç‡ã®UIã‚’æ›´æ–°
              usedMultipliers.forEach(multiplier => {
                const btn = document.querySelector(`.multiplier-btn[data-value="${multiplier}"]`);
                if (btn) {
                  btn.disabled = true;
                  btn.classList.add('used');
                }
              });
            } catch (e) {
              localStorage.removeItem('gec_used_multipliers');
            }
          }
          
          // å€ç‡ãƒœã‚¿ãƒ³ã®è¨­å®š
          document.querySelectorAll('.multiplier-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              if (btn.disabled || btn.classList.contains('used')) return;
              
              // å›ç­”æ¸ˆã¿ã®å ´åˆã¯å€ç‡å¤‰æ›´ã‚’ç¦æ­¢
              if (hasVotedThisRound) {
                msg.textContent = 'å›ç­”å¾Œã¯å€ç‡ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“';
                return;
              }
              
              document.querySelectorAll('.multiplier-btn').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
              selectedMultiplier = parseInt(btn.dataset.value);
              updateVoteButtons();
              msg.textContent = `${selectedMultiplier}ç‚¹ã‚’é¸æŠã—ã¾ã—ãŸ`;
            });
          });
          
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Ã—1ã‚’é¸æŠ
          document.querySelector('.multiplier-btn[data-value="1"]').classList.add('selected');
        });

        /* ===== SignalR ===== */
        const conn=new signalR.HubConnectionBuilder()
          .withUrl('/hub/vote', { transport: signalR.HttpTransportType.LongPolling })
          .withAutomaticReconnect()
          .build();

        conn.on('StateUpdated', s=>{
          const q=s.question||s.Question;
          const opts=q.options||q.Options||[];
          isVotingOpen = s.isVotingOpen || s.IsVotingOpen || false;
          const newIndex = s.currentIndex || s.CurrentIndex || 0;
          
          // å•é¡ŒãŒå¤‰ã‚ã£ãŸã¨ã
          if (newIndex !== currentQuestionIndex) {
            currentQuestionIndex = newIndex;
            hasVotedThisRound = false;
            currentSelectedOption = null;
            
            // ä¿å­˜ã•ã‚ŒãŸå›ç­”ãŒã‚ã‚Œã°å¾©å…ƒ
            if (savedVotes[currentQuestionIndex]) {
              const saved = savedVotes[currentQuestionIndex];
              currentSelectedOption = saved.option;
              hasVotedThisRound = true;
            }
          }
          
          qTitle.textContent=q.title||q.Title||'';

          // æŠ•ç¥¨ã‚¨ãƒªã‚¢ã®è¡¨ç¤º/éè¡¨ç¤º
          if (isVotingOpen) {
            votingArea.classList.remove('hide');
            votingClosed.classList.add('hide');
            if (hasVotedThisRound) {
              msg.textContent = `ã“ã®å•é¡Œã¯ ${currentSelectedOption} (${savedVotes[currentQuestionIndex]?.multiplier || '?'}ç‚¹) ã§å›ç­”æ¸ˆã¿ã§ã™`;
            } else {
              msg.textContent = 'ç‚¹æ•°ã‚’é¸æŠã—ã¦ã‹ã‚‰å›ç­”ã—ã¦ãã ã•ã„';
            }
          } else {
            votingArea.classList.add('hide');
            votingClosed.classList.remove('hide');
            msg.textContent = 'å›ç­”å—ä»˜åœæ­¢ä¸­';
          }

          wrap.innerHTML='';
          const teamNow=getTeam();
          for(const o of opts){
            const label=o.label||o.Label;
            if(!['A','B'].includes(label)) continue;
            const b=document.createElement('button');
            b.className='choice';
            b.textContent=`${label} ã‚’é¸ã¶`;
            b.disabled = !teamNow || !isVotingOpen || selectedMultiplier === 0;
            // å›ç­”æ¸ˆã¿ã®é¸æŠè‚¢ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            if (currentSelectedOption === label) {
              b.classList.add('selected-answer');
            }
            
            b.onclick=()=> {
              if (!selectedMultiplier || selectedMultiplier === 0) {
                msg.textContent = 'å…ˆã«ç‚¹æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„';
                return;
              }
              
              if (hasVotedThisRound) {
                msg.textContent = 'ã“ã®å•é¡Œã¯æ—¢ã«å›ç­”æ¸ˆã¿ã§ã™';
                return;
              }
              
              // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
              showConfirmModal(label, teamNow);
            };
            wrap.appendChild(b);
          }
          setConn(true);
          updateVoteButtons();
        });
        
        conn.on('VotingStatusChanged', isOpen => {
          isVotingOpen = isOpen;
          if (isOpen) {
            hasVotedThisRound = false;  // æ–°ã—ã„æŠ•ç¥¨ãŒé–‹å§‹ã•ã‚ŒãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
            currentSelectedOption = null;
            document.querySelectorAll('.choice').forEach(b => b.classList.remove('selected-answer'));
            // å€ç‡ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
              if (!btn.classList.contains('used')) {
                btn.style.pointerEvents = '';
                btn.style.opacity = '';
              }
            });
            votingArea.classList.remove('hide');
            votingClosed.classList.add('hide');
            msg.textContent = 'ç‚¹æ•°ã‚’é¸æŠã—ã¦ã‹ã‚‰å›ç­”ã—ã¦ãã ã•ã„';
          } else {
            votingArea.classList.add('hide');
            votingClosed.classList.remove('hide');
            msg.textContent = 'å›ç­”å—ä»˜åœæ­¢ä¸­';
          }
          updateVoteButtons();
        });
        
        conn.on('MultiplierUsed', multiplier => {
          usedMultipliers.push(multiplier);
          hasVotedThisRound = true;  // æŠ•ç¥¨æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
          
          // ç¾åœ¨ã®å•é¡Œã®å›ç­”ã‚’ä¿å­˜
          savedVotes[currentQuestionIndex] = {
            option: currentSelectedOption,
            multiplier: multiplier
          };
          
          // localStorageã«ä¿å­˜
          localStorage.setItem('gec_saved_votes', JSON.stringify(savedVotes));
          localStorage.setItem('gec_used_multipliers', JSON.stringify(usedMultipliers));
          
          // é¸æŠã—ãŸãƒœã‚¿ãƒ³ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
          if (currentSelectedOption) {
            document.querySelectorAll('.choice').forEach(b => {
              if (b.textContent === `${currentSelectedOption} ã‚’é¸ã¶`) {
                b.classList.add('selected-answer');
              }
            });
          }
          
          // å›ç­”å¾Œã¯ã™ã¹ã¦ã®å€ç‡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆä½¿ç”¨æ¸ˆã¿å€ç‡ã¯åˆ¥é€”å‡¦ç†ï¼‰
          document.querySelectorAll('.multiplier-btn').forEach(btn => {
            const value = parseInt(btn.dataset.value);
            if (usedMultipliers.includes(value)) {
              btn.disabled = true;
              btn.classList.add('used');
              btn.classList.remove('selected');
            } else if (hasVotedThisRound) {
              // å›ç­”æ¸ˆã¿ã®å ´åˆã€æœªä½¿ç”¨ã®å€ç‡ã‚‚ç„¡åŠ¹åŒ–ï¼ˆãŸã ã—è¦‹ãŸç›®ã¯å¤‰ãˆãªã„ï¼‰
              btn.style.pointerEvents = 'none';
              btn.style.opacity = '0.7';
            }
          });
          
          // æ¬¡ã®åˆ©ç”¨å¯èƒ½ãªå€ç‡ã‚’è‡ªå‹•é¸æŠ
          selectedMultiplier = 0;
          for (const value of [1, 2, 4]) {
            if (!usedMultipliers.includes(value)) {
              selectedMultiplier = value;
              document.querySelector(`.multiplier-btn[data-value="${value}"]`).classList.add('selected');
              break;
            }
          }
          updateVoteButtons();
        });

        // å›ç­”ä¸€è¦§è¡¨ç¤ºã®å‡¦ç†
        conn.on('AnswerListReceived', answerList => {
          // å›ç­”ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          const modal = document.createElement('div');
          modal.className = 'confirm-modal';
          modal.style.display = 'flex';
          modal.style.zIndex = '2000';

          const questionTitle = answerList.QuestionTitle || answerList.questionTitle;
          const totalResponses = answerList.TotalResponses || answerList.totalResponses;
          const answerGroups = answerList.AnswerGroups || answerList.answerGroups || [];

          let html = `<div style="color:#666;margin-bottom:12px;">ç·å›ç­”æ•°: ${totalResponses}ä»¶</div>`;

          answerGroups.forEach(group => {
            const option = group.Option || group.option;
            const count = group.Count || group.count;
            const teams = group.Teams || group.teams || [];

            html += `
              <div style="margin-bottom:20px;padding:16px;background:#f9fafb;border-radius:8px;">
                <div style="font-size:18px;font-weight:700;color:#111;margin-bottom:12px;">
                  é¸æŠè‚¢ ${option} <span style="font-weight:400;color:#666;">(${count}ä»¶)</span>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:8px;">
            `;

            teams.forEach(team => {
              const teamName = team.TeamName || team.teamName;
              const multiplier = team.Multiplier || team.multiplier;
              const clientId = team.ClientId || team.clientId;
              const isMyAnswer = clientId === conn.connectionId;

              html += `
                <div style="padding:8px 12px;background:${isMyAnswer ? '#fef3c7' : 'white'};border:1px solid ${isMyAnswer ? '#f59e0b' : '#e5e7eb'};border-radius:6px;">
                  <span style="font-weight:600;">${teamName}</span>
                  <span style="color:#666;margin-left:8px;">Ã—${multiplier}</span>
                  ${isMyAnswer ? '<span style="color:#f59e0b;margin-left:8px;">(ã‚ãªãŸ)</span>' : ''}
                </div>
              `;
            });

            html += `
                </div>
              </div>
            `;
          });

          modal.innerHTML = `
            <div class="confirm-box" style="max-width:800px;max-height:80vh;overflow-y:auto;">
              <div class="confirm-title">å›ç­”ä¸€è¦§</div>
              <div style="color:#666;margin-bottom:20px;font-size:18px;font-weight:600;">${questionTitle}</div>
              <div style="margin:20px 0;">${html}</div>
              <div class="confirm-buttons">
                <button class="confirm-btn confirm-ok" style="width:100%;">é–‰ã˜ã‚‹</button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          modal.querySelector('.confirm-ok').onclick = () => {
            document.body.removeChild(modal);
          };
        });

        // æœ€çµ‚çµæœè¡¨ç¤ºã®å‡¦ç†ã‚’è¿½åŠ 
        conn.on('GameResults', results => {
          // æœ€çµ‚çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          const modal = document.createElement('div');
          modal.className = 'confirm-modal';
          modal.style.display = 'flex';
          modal.style.zIndex = '2000';

          let html = '<table style="width:100%;"><tr><th>é †ä½</th><th>ãƒãƒ¼ãƒ å</th><th>åˆè¨ˆç‚¹æ•°</th><th>åˆè¨ˆæ™‚é–“</th></tr>';
          results.forEach((r, i) => {
            const teamName = r.teamName || r.TeamName || (r.clientId || r.ClientId || '').substring(0, 8);
            html += `<tr>
              <td>${i + 1}ä½</td>
              <td>${teamName}</td>
              <td>${r.totalPoints || r.TotalPoints || 0}ç‚¹</td>
              <td>${((r.totalTime || r.TotalTime) || 0).toFixed(1)}ç§’</td>
            </tr>`;
          });
          html += '</table>';

          modal.innerHTML = `
            <div class="confirm-box" style="max-width:600px;">
              <div class="confirm-title">æœ€çµ‚çµæœ</div>
              <div style="margin:20px 0;overflow-x:auto;">${html}</div>
              <div class="confirm-buttons">
                <button class="confirm-btn confirm-ok" style="width:100%;">é–‰ã˜ã‚‹</button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          modal.querySelector('.confirm-ok').onclick = () => {
            document.body.removeChild(modal);
          };
        });

        conn.start()
          .then(()=>{ setConn(true,'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'); return conn.invoke('GetState'); })
          .catch(()=> setConn(false,'æ¥ç¶šã§ãã¾ã›ã‚“'));

        conn.onreconnecting(()=> setConn(false,'å†æ¥ç¶šä¸­â€¦'));
        conn.onreconnected(()=> setConn(true,'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'));
        conn.onclose(()=> setConn(false,'åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ'));

        addEventListener('offline', ()=> setConn(false,'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'));
        addEventListener('online',  ()=> setConn(true,'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'));
        
        // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆæ™‚ã®å‡¦ç†
        conn.on('GameReset', () => {
            // ã™ã¹ã¦ã®å€ç‡ã‚’ãƒªã‚»ãƒƒãƒˆ
            usedMultipliers = [];
            selectedMultiplier = 1;
            hasVotedThisRound = false;
            currentSelectedOption = null;
            savedVotes = {};
            currentQuestionIndex = 0;
            
            // localStorage ã‚‚ã‚¯ãƒªã‚¢
            localStorage.removeItem('gec_saved_votes');
            localStorage.removeItem('gec_used_multipliers');
            
            // UIã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('used');
                btn.classList.remove('selected');
            });
            
            // Ã—1ã‚’é¸æŠ
            document.querySelector('.multiplier-btn[data-value="1"]').classList.add('selected');
            
            // é¸æŠæ¸ˆã¿ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.choice').forEach(b => b.classList.remove('selected-answer'));
            
            msg.textContent = 'ã‚²ãƒ¼ãƒ ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ';
        });
        
        // å›ç­”ãŒå‰Šé™¤ã•ã‚ŒãŸã¨ãã®å‡¦ç†
        conn.on('VoteDeleted', (clientId, deletedMultiplier) => {
          if (clientId === conn.connectionId) {
            hasVotedThisRound = false;
            currentSelectedOption = null;
            document.querySelectorAll('.choice').forEach(b => b.classList.remove('selected-answer'));
            msg.textContent = 'å›ç­”ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚å†åº¦å›ç­”ã§ãã¾ã™';
            
            // å‰Šé™¤ã•ã‚ŒãŸå€ç‡ã‚’å†åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
            if (deletedMultiplier && usedMultipliers.includes(deletedMultiplier)) {
              const index = usedMultipliers.indexOf(deletedMultiplier);
              if (index > -1) {
                usedMultipliers.splice(index, 1);
              }
              
              const btn = document.querySelector(`.multiplier-btn[data-value="${deletedMultiplier}"]`);
              if (btn) {
                btn.disabled = false;
                btn.classList.remove('used');
                
                // è‡ªå‹•ã§å‰Šé™¤ã•ã‚ŒãŸå€ç‡ã‚’é¸æŠ
                if (selectedMultiplier === 0) {
                  btn.classList.add('selected');
                  selectedMultiplier = deletedMultiplier;
                  msg.textContent = `${selectedMultiplier}ç‚¹ãŒå†åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ`;
                }
              }
            }
            updateVoteButtons();
          }
        });
        
        // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
        function showConfirmModal(label, teamName) {
          const modal = document.createElement('div');
          modal.className = 'confirm-modal';
          modal.style.display = 'flex';
          
          modal.innerHTML = `
            <div class="confirm-box">
              <div class="confirm-title">ğŸ“ å›ç­”ç¢ºèª</div>
              <div class="confirm-message">
                ã“ã®é¸æŠã§å›ç­”ã—ã¾ã™ã€‚<br>
                ä¸€åº¦å›ç­”ã™ã‚‹ã¨å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚
              </div>
              <div class="confirm-choice">${label}</div>
              <div class="confirm-choice-detail">
                <div class="confirm-choice-item">
                  <div class="confirm-choice-label">ãƒãƒ¼ãƒ å</div>
                  <div class="confirm-choice-value">${teamName || 'æœªè¨­å®š'}</div>
                </div>
                <div class="confirm-choice-item">
                  <div class="confirm-choice-label">ä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆ</div>
                  <div class="confirm-choice-value">${selectedMultiplier}ç‚¹</div>
                </div>
              </div>
              <div class="confirm-buttons">
                <button class="confirm-btn confirm-cancel">æˆ»ã‚‹</button>
                <button class="confirm-btn confirm-ok">ç¢ºå®šã™ã‚‹ âœ“</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          modal.querySelector('.confirm-cancel').onclick = () => {
            document.body.removeChild(modal);
          };
          
          modal.querySelector('.confirm-ok').onclick = () => {
            currentSelectedOption = label;
            conn.invoke('SubmitWithMultiplier', label, selectedMultiplier, teamName).then(()=>{
              msg.textContent=`${teamName?('['+teamName+'] '):''}${label} ã‚’ ${selectedMultiplier}ç‚¹ã§é¸æŠã—ã¾ã—ãŸ`;
              try{ navigator.vibrate && navigator.vibrate(15); }catch{}
            });
            document.body.removeChild(modal);
          };
        }
    </script>
</body>
</html>